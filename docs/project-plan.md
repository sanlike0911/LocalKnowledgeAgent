# LocalKnowledgeAgent 開発計画書

計画書バージョン: 2.0
作成日時: 2025.08.30
更新日時: 2025.08.30

## プロジェクト概要

LocalKnowledgeAgentは、**Streamlit**ベースのデスクトップWebアプリケーションです。
ローカル環境でPDFとTXTファイルを処理し、**LangChain + ChromaDB + Ollama**による
RAGシステムで質問応答を提供します。

**重要**: 本開発計画書は、CLAUDE.mdとdocs/design-specification.md に厳密に従って作成されています。

## 設計書遵守事項

### システムアーキテクチャ (設計書準拠)

- **UI層**: Streamlit (必須)
- **ロジック層**: LangChain RAGパイプライン
- **データ層**: ChromaDB (ベクトルDB) + config.json
- **LLM層**: Ollama (ローカル実行)

### 必須画面 (設計書準拠)

- **SCR-01**: メイン画面 (チャット形式Q&A)
- **SCR-02**: 設定画面 (フォルダ管理・インデックス)

## 開発フェーズ

### Phase 1: プロジェクト基盤構築・環境整備 (1日目)

#### 1.1 開発環境セットアップ (設計書準拠)

**ファイル構造構築** (設計書仕様)

- [ ] プロジェクト構造の再構築

  ```text
  local-knowledge-agent/
  ├── .streamlit/
  │   └── config.toml
  ├── data/
  │   ├── chroma_db/
  │   └── config.json
  ├── src/
  │   ├── logic/
  │   │   ├── __init__.py
  │   │   ├── indexing.py
  │   │   └── qa.py
  │   └── ui/
  │       ├── __init__.py
  │       ├── main_view.py
  │       └── settings_view.py
  ├── tests/
  │   ├── logic/
  │   └── ui/
  ├── app.py
  ├── requirements.txt
  └── pyproject.toml
  ```

**必須依存関係インストール** (設計書仕様)

- [x] Streamlit フレームワーク
- [x] LangChain RAGパイプライン
- [x] ChromaDB ベクトルストア
- [x] Ollama Python SDK
- [x] PyPDF2 (PDF処理)
- [x] 既存依存関係の整理

**開発環境構築** (CLAUDE.md準拠)

- [x] .env.example テンプレートファイル作成
- [x] .env ファイル作成（環境変数設定）
- [x] 環境変数バリデーション機能実装
- [x] 設定値の安全な読み込み機能

**Streamlit設定** (設計書仕様)

- [x] .streamlit/config.toml 作成
- [x] ページ設定、テーマ設定
- [x] セッションステート初期化

### Phase 2: コアアーキテクチャ設計・TDD実装基盤 (1日目)

#### 2.1 システム設計 (TDD手法・設計書準拠)

**データモデル設計** (TDD Red フェーズ)

- [x] Document モデル設計・テスト作成
- [x] Config モデル設計・テスト作成
- [x] ChatHistory モデル設計・テスト作成
- [x] AppState モデル設計・テスト作成

**インターフェース定義** (TDD Red フェーズ)

- [x] IndexingInterface インターフェース・テスト作成
- [x] QAInterface インターフェース・テスト作成
- [x] ConfigInterface インターフェース・テスト作成

#### 2.2 例外・ユーティリティクラス (CLAUDE.md準拠)

**例外クラス** (TDD適用)

- [x] IndexingError, QAError, ConfigError
- [x] 日本語エラーメッセージ必須
- [x] エラーコード体系整備

**ログ・ユーティリティ** (CLAUDE.md準拠)

- [x] 構造化ログ実装 (JSON形式)
- [x] 進捗表示ユーティリティ (3秒以上処理用)
- [x] キャンセル制御ユーティリティ

### Phase 3: RAGシステム実装 (2日目)

#### 3.1 ChromaDB インデックス機能 (TDD適用・設計書準拠)

**インデックス作成** (Red-Green-Refactor)

- [ ] テストケース: PDF/TXT読み込みテスト
- [ ] 最小実装: ファイル読み込み・ベクトル化
- [ ] リファクタリング: エラーハンドリング・最適化

**インデックス管理** (Red-Green-Refactor)

- [ ] テストケース: インデックス更新・削除テスト
- [ ] 最小実装: CRUD操作
- [ ] リファクタリング: パフォーマンス最適化

#### 3.2 LangChain QAシステム (TDD適用・設計書準拠)

**RAG パイプライン** (Red-Green-Refactor)

- [ ] テストケース: 文書検索・回答生成テスト
- [ ] 最小実装: LangChain + ChromaDB統合
- [ ] リファクタリング: プロンプト最適化

**Ollama統合** (Red-Green-Refactor)

- [ ] テストケース: ローカルLLM接続テスト
- [ ] 最小実装: Ollama API統合
- [ ] リファクタリング: レスポンス最適化

#### 3.3 設定管理システム (TDD適用・設計書準拠)

**設定保存・読み込み** (Red-Green-Refactor)

- [ ] テストケース: config.json操作テスト
- [ ] 最小実装: 設定CRUD操作
- [ ] リファクタリング: バリデーション強化

### Phase 4: Streamlit UI実装 (2日目)

#### 4.1 メイン画面実装 (SCR-01・設計書準拠)

**チャットインターフェース** (TDD適用)

- [ ] テストケース: チャット履歴表示・更新テスト
- [ ] 最小実装: st.chat_message, st.chat_input
- [ ] リファクタリング: UX改善・エラーハンドリング

**リアルタイム進捗表示** (CLAUDE.md準拠)

- [ ] テストケース: 進捗バー・スピナー表示テスト
- [ ] 最小実装: st.progress, st.spinner統合
- [ ] リファクタリング: キャンセル機能統合

**回答生成・表示** (設計書準拠)

- [ ] テストケース: 回答フォーマット・ソース表示テスト
- [ ] 最小実装: QAシステム統合・結果表示
- [ ] リファクタリング: エラー処理・日本語化

#### 4.2 設定画面実装 (SCR-02・設計書準拠)

**フォルダ選択・管理** (TDD適用)

- [ ] テストケース: ディレクトリ選択・表示テスト
- [ ] 最小実装: st.file_uploader, ディレクトリ選択
- [ ] リファクタリング: パス検証・エラーハンドリング

**インデックス管理UI** (TDD適用)

- [ ] テストケース: インデックス作成・削除ボタンテスト
- [ ] 最小実装: インデックス操作UI
- [ ] リファクタリング: 進捗表示・結果フィードバック

**設定保存・復元** (設計書準拠)

- [ ] テストケース: 設定値保存・読み込みテスト
- [ ] 最小実装: フォーム入力・設定連携
- [ ] リファクタリング: バリデーション・UX改善

#### 4.3 状態管理・ナビゲーション (設計書準拠)

**セッションステート管理** (設計書必須)

- [ ] app_state: 'idle', 'processing_qa', 'processing_indexing'
- [ ] cancel_requested: キャンセルフラグ
- [ ] chat_history: 対話履歴
- [ ] config: アプリケーション設定

**画面間ナビゲーション** (設計書準拠)

- [ ] テストケース: ページ遷移・状態保持テスト
- [ ] 最小実装: st.sidebar ナビゲーション
- [ ] リファクタリング: 状態同期・UX改善

### Phase 5: 統合・品質保証 (2日目)

#### 5.1 システム統合テスト (TDD統合)

**E2Eテスト** (設計書シナリオ)

- [ ] PDF インデックス作成→質問→回答 フルフロー
- [ ] 設定変更→インデックス再作成 フロー
- [ ] エラー処理→回復 フロー
- [ ] キャンセル操作 フロー

**パフォーマンステスト** (設計書要件)

- [ ] 回答生成30秒以内テスト
- [ ] 大容量PDF処理テスト
- [ ] メモリ使用量測定

#### 5.2 UI/UXテスト (CLAUDE.md準拠)

**ユーザビリティテスト** ()

- [ ] 日本語エラーメッセージ検証
- [ ] 進捗表示動作確認 (3秒以上処理)
- [ ] キャンセル機能動作確認
- [ ] レスポンシブデザイン確認

#### 5.3 セキュリティ・品質保証 (CLAUDE.md準拠)

**入力検証・セキュリティ** ()

- [ ] ファイルアップロード検証
- [ ] パス トラバーサル対策
- [ ] XSS対策 (Streamlit標準機能)

**コード品質最終チェック** ()

- [ ] 型ヒント100%適用確認
- [ ] docstring完備確認
- [ ] テストカバレッジ90%以上達成

### Phase 6: デプロイ・運用準備 (1日目)

#### 6.1 パッケージング・配布準備

**Streamlitアプリ最適化** ()

- [ ] requirements.txt最終調整
- [ ] .streamlit/config.toml本番設定
- [ ] app.py エントリーポイント最適化

**ドキュメント整備** (CLAUDE.md準拠)

- [ ] README.md更新 (Streamlit実行手順)
- [ ] インストール手順書作成
- [ ] ユーザーマニュアル作成 (SCR-01, SCR-02)

#### 6.2 運用・保守準備

**ログ・モニタリング** (CLAUDE.md準拠)

- [ ] 構造化ログ出力確認
- [ ] エラー追跡機能確認
- [ ] パフォーマンス監視設定

**バックアップ・復旧** ()

- [ ] ChromaDB バックアップ機能
- [ ] 設定ファイル保存・復元機能

## 技術スタック (設計書準拠)

### 必須フレームワーク・ライブラリ

- **UI Framework**: **Streamlit** (必須)
- **RAG Framework**: **LangChain** (必須)
- **Vector Database**: **ChromaDB** (必須)
- **Local LLM**: **Ollama** (必須)
- **Document Processing**: PyPDF2, python-docx
- **Testing**: pytest, pytest-streamlit

### アーキテクチャパターン (設計書準拠)

- **4層アーキテクチャ**: UI / Logic / Data / LLM
- **状態管理**: Streamlit Session State
- **設定管理**: JSON ファイルベース
- **キャンセル制御**: フラグベース制御

## 開発手法・品質基準 (CLAUDE.md準拠)

### TDD実装サイクル (**必須**)

1. **機能仕様明確化**
2. **テストケース作成** (Red フェーズ)
3. **最小実装** (Green フェーズ)
4. **リファクタリング** (Refactor フェーズ)

### 品質基準 (**必須**)

- **型ヒント**: 全関数に必須
- **docstring**: 全クラス・関数に必須
- **日本語コメント**: 複雑ロジックに必須
- **エラーメッセージ**: 日本語必須
- **進捗表示**: 3秒以上処理に必須
- **TodoWrite**: 全タスクに必須

### コーディング規約 (CLAUDE.md準拠)

- **関数・変数**: snake_case
- **クラス**: PascalCase
- **定数**: UPPER_SNAKE_CASE
- **静的解析**: flake8, mypy, black必須

## プロジェクト成功基準

### 機能要件達成

- [ ] **PDF/TXT文書の自動インデックス** (設計書準拠)
- [ ] **LangChain RAGによる高精度回答生成** (設計書準拠)
- [ ] **Streamlit 2画面UI完全実装** (設計書準拠)
- [ ] **リアルタイム進捗表示・キャンセル機能** (設計書準拠)

### 品質要件達成 (CLAUDE.md準拠)

- [ ] **TDD完全適用** (Red-Green-Refactor)
- [ ] **テストカバレッジ90%以上**
- [ ] **型ヒント・docstring 100%**
- [ ] **日本語エラーメッセージ完備**

### パフォーマンス要件 (設計書準拠)

- [ ] **回答生成30秒以内**
- [ ] **進捗表示3秒ルール遵守**
- [ ] **ローカル実行完全対応**

---

**重要**: 本計画書は設計書 (docs/design-specification.md) とCLAUDE.md の要件に完全準拠して作成されています。実装時は必ずこれらの文書と照合しながら進めてください。
