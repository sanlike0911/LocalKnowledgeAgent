# システム設計仕様書 Ver. 2.4

## プロジェクト名： ローカルナレッジエージェント (MVP)

### 1. 概要

#### 1.1. プロジェクト概要

本仕様書は、「ローカルナレッジエージェント (MVP)」アプリケーションのシステム全体に関する設計を定義するものです。本システムは、機密情報を外部に送信することなく、ユーザーのローカルPC内で全ての処理が完結するスタンドアロンのデスクトップアプリケーションです。ユーザーが指定したローカル文書（PDF, TXT）をナレッジベースとし、大規模言語モデル（LLM）を活用して対話形式での情報検索を実現します。

本仕様書は、AIコーディングエージェントによる自動実装を想定しており、アーキテクチャ、データフロー、UI/UX、状態管理など、開発に必要なすべての仕様を網羅しています。

**改訂履歴**  

* Ver. 2.1: AIエージェントの理解を促進するため、情報の構成を再編成。
* Ver. 2.2: 「主要機能」「ファイル・ディレクトリ構造」のセクションを追加し、構成を最適化。
* Ver. 2.3: 日本語固定回答制御機能の仕様を追加。
* Ver. 2.4: 必須となるOllamaモデルを明記。

#### 1.2. 主要機能

本アプリケーションがMVP（Minimum Viable Product）として提供する主要な機能は以下の通りです。

* **対話形式によるナレッジ検索:** 自然言語での質問に対し、登録された社内文書の内容を基に要約された回答を生成します（RAG機能）。
* **ローカル完結処理:** 全てのデータ処理（文書のインデックス作成、LLMによる回答生成など）がユーザーのPC内で完結し、機密情報が外部に送信されることはありません。
* **対象文書の管理:** ユーザーはナレッジベースとして使用するフォルダをGUIから指定できます。
* **出典の明示:** 生成された回答には、根拠となった文書のファイル名が必ず併記され、情報のトレーサビリティを確保します。
* **手動インデックス更新:** ユーザーは任意のタイミングで、ナレッジベースのインデックスを最新の状態に更新できます。
* **処理の中断:** 時間のかかる処理（Q&A応答生成、インデックス作成）をユーザーが任意に中断できる機能を備えます。
* **日本語固定回答制御:** 全ての質問に対して日本語で回答を生成するよう制御し、一貫性のあるユーザー体験を提供します。

---

### 2. システムアーキテクチャ

#### 2.1. アーキテクチャ概要

本システムのアーキテクチャは、UI層、バックエンドロジック層、データストア層、LLM実行環境の4つの主要な層で構成され、全てのコンポーネントはユーザーのローカルPC内で動作します。

* **UI層 (Frontend):** **Streamlit** を使用し、ユーザーとのインタラクション、状態の表示、バックエンド処理のトリガーを担当します。
* **バックエンドロジック層 (Backend Logic):** **LangChain** をフレームワークの中心に据え、RAG (検索拡張生成) パイプライン全体の制御を行います。
* **データストア層 (Data Stores):** 文書ベクトルを管理する **ChromaDB**、永続化設定を保存する **config.json**、そしてアプリケーションの動的な状態を管理する **Streamlit Session State** で構成されます。
* **LLM実行環境 (LLM Runtime):** **Ollama** を使用し、ローカル環境で大規模言語モデル（LLM）を安全に実行します。

アプリケーションの状態管理は **Streamlit Session State (`st.session_state`)** が中核を担い、UI層とバックエンドロジック層の間の情報連携を司ります。これにより、Streamlitの再実行モデルの中でも状態を維持し、中断処理のような複雑なインタラクションを実現します。

#### 2.2. アーキテクチャ図

```mermaid
graph TD
    subgraph ユーザーPC (ローカル環境)
        subgraph UI層 (Frontend - Streamlit)
            A[ユーザー] <--> UI(メイン画面 / 設定画面);
            UI -- (1) ユーザー操作 (質問/更新/キャンセル) --> SS[st.session_state];
            SS -- (2) 状態をUIに反映 --> UI;
        end

        subgraph バックエンドロジック層 (Backend Logic - LangChain)
            C{アプリケーション制御ロジック};
            SS -- (3) 状態変更をトリガー --> C;
            C -- (4) RAGパイプライン実行 --> RAG;
            RAG(RAGパイプライン  Document Loader, Text Splitter, Retriever, Prompting);
            C -- (9) 処理結果/進捗を更新 --> SS;
            C -- (A) ループ内で定期的にチェック --> SS_Cancel[st.session_state  cancel_requested];
            SS_Cancel -- (B) Trueの場合 --> C{処理中断};
        end

        subgraph LLM実行環境 (LLM Runtime)
            F[LLM (Ollama)];
        end
        
        subgraph データストア層 (Data Stores)
            E[ベクトルDB  ChromaDB];
            G[文書ファイル  PDF, TXT];
            CONF[設定ファイル  config.json];
            EM[Embedding Model];
        end

        %% データフロー
        RAG -- (5) 文書読み込み --> G;
        RAG -- (6) チャンクをベクトル化 --> EM;
        EM -- (7) ベクトルとテキストを保存/検索 --> E;
        RAG -- (8) プロンプトを生成し実行 --> F;
        C -- 初期起動/設定変更 --> CONF;
    end
```

#### 2.3. コンポーネント詳細

* **UI層 (Streamlit):**
  * **役割:** ユーザーからの入力を受け付け、`st.session_state` を更新することでバックエンド処理をトリガーします。また、`st.session_state` の内容に基づいて画面（チャット履歴、処理ステータス、エラーメッセージ等）を動的に描画します。
  * **責務:** ユーザーインタフェースの提供に専念し、複雑なビジネスロジックは保持しません。

* **バックエンドロジック層 (LangChain):**
  * **役割:** Streamlitからトリガーされた処理を実行します。RAGパイプライン（文書の読み込み、分割、ベクトル化、検索、LLMへの問い合わせ）の全体を制御します。
  * **責務:** `st.session_state` を監視し、状態の変更に応じて適切な処理を実行します。インデックス作成やQ&A応答生成のような時間のかかる処理のループ内で `st.session_state['cancel_requested']` を定期的に参照し、中断要求に対応します。処理の進捗や結果は `st.session_state` に書き込むことでUI層に通知します。

* **データストア層:**
  * **ベクトルDB (ChromaDB):** 文書を分割したチャンクのテキストデータと、それに対応する数値ベクトルを保存します。高速な類似度検索機能を提供し、RAGの検索フェーズで中心的な役割を果たします。
  * **設定ファイル (config.json):** ユーザーが指定したナレッジフォルダのパスやインデックスの最終更新日時など、アプリケーションの再起動後も保持すべき情報を永続的に保存します。
  * **セッション状態 (`st.session_state`):** アプリケーション実行中の揮発的な状態（`app_state`, `cancel_requested`, `chat_history`）を管理します。UIとバックエンド間の情報の受け渡しを行うハブとして機能します。

* **LLM実行環境 (Ollama):**
  * **役割:** バックエンド層から渡されたプロンプト（ユーザーの質問と関連文書）を基に、自然言語の回答を生成します。
  * **責務:** LLMの推論処理を実行することに専念します。
  * **必須モデル:** 本アプリケーションの動作には、Ollamaに以下のモデルがインストールされている必要があります。
    * **回答生成用LLM:** `llama3:8b`
    * **埋め込み（ベクトル変換）用モデル:** `nomic-embed-text`
  * **確認・インストール:** アプリケーションは起動時に、必須モデル（`llama3:8b`, `nomic-embed-text`）がOllamaで利用可能かを確認します。一つでも利用できないモデルがある場合は、どのモデルが不足しているかを明記した上で、Ollamaでのモデルインストール方法（例：`ollama pull llama3:8b`）を案内するメッセージをユーザーに表示する仕様とします。

#### 2.4. データフロー

##### 2.4.1. 初回起動フロー

1. アプリケーションが起動します。
2. バックエンドロジックが `config.json` ファイルの存在と内容をチェックします。
3. ファイルが存在しないか、有効なフォルダパスが設定されていない場合、`st.session_state` に初期設定が必要である旨のフラグを立てます。
4. UI層が `st.session_state` を参照し、初期設定を促すメッセージを表示し、Q&A機能を無効化します。
5. ファイルが存在し設定が有効な場合は、設定内容を `st.session_state['config']` にロードします。

##### 2.4.2. インデックス作成フロー

1. ユーザーが設定画面で「今すぐ更新」ボタンをクリックします。
2. UI層が `st.session_state['app_state']` を `'processing_indexing'` に変更します。
3. バックエンドロジックが `app_state` の変更を検知し、インデックス作成プロセスを開始します。
4. **[ループ開始]** 指定されたフォルダから対象ファイル（PDF, TXT）を一つずつ読み込みます (Document Loader)。
5. 読み込んだ文書を意味のあるチャンクに分割します (Text Splitter)。
6. 各チャンクをEmbedding Modelで数値ベクトルに変換します。
7. ベクトルと元のテキストをChromaDBに保存します。
8. UI層に進捗（処理済みファイル数）を `st.session_state` 経由で通知し、UIが進捗バーを更新します。
9. **[中断チェック]** ループの各イテレーションで `st.session_state['cancel_requested']` を確認。`True` ならばループを中断し、不完全なインデックスデータを破棄して終了します。
10. **[ループ終了]** 全てのファイルの処理が完了したら、`config.json` に現在の時刻を「最終更新日時」として保存し、`st.session_state['app_state']` を `'idle'` に戻します。

##### 2.4.3. Q&Aフロー

1. ユーザーがメイン画面で質問を入力し、「送信」ボタンをクリックします。
2. UI層が `st.session_state['app_state']` を `'processing_qa'` に変更し、ユーザーの質問を `st.session_state` に保存します。
3. バックエンドロジックが `app_state` の変更を検知し、Q&Aプロセスを開始します。
4. 質問文をEmbedding Modelでベクトルに変換します。
5. **[中断チェックポイント1]** `st.session_state['cancel_requested']` を確認します。
6. 質問ベクトルを用いてChromaDBから類似度の高い文書チャンクを複数検索・取得します (Retriever)。
7. **[中断チェックポイント2]** `st.session_state['cancel_requested']` を確認します。
8. 取得した文書チャンクをコンテキストとして、質問文と組み合わせたプロンプトを生成します。このプロンプトには「日本語で回答してください。」という指示を含めます。
9. 生成したプロンプト（日本語指示付き）をOllamaに渡し、回答生成をリクエストします。
10. **[中断チェックポイント3 (ベストエフォート)]** Ollamaの処理はアトミックな場合が多いため、MVPではOllamaの応答待ちは中断不可でも許容します。
11. Ollamaから回答が返却されたら、回答テキストと出典情報（検索された文書のファイル名）を `st.session_state['chat_history']` に追加します。
12. `st.session_state['app_state']` を `'idle'` に戻します。
13. UI層が `st.session_state` の変更を検知し、チャット履歴を更新して新しい回答を表示します。

---

### 3. 画面仕様

#### 3.1. 画面一覧

| 画面ID | 画面名 | 概要 |
| :--- | :--- | :--- |
| SCR-01 | メイン画面 | ユーザーが質問を入力し、AIからの回答と出典を確認する主要画面。 |
| SCR-02 | 設定画面 | ナレッジソースとなるフォルダの指定や、文書インデックスの管理を行う画面。 |

#### 3.2. メイン画面 (SCR-01) 詳細

##### 3.2.1. ワイヤーフレーム

**通常時:**

```text
+-----------------------------------------------------------------+
| ローカルナレッジアシスタント v0.1                                |
+-----------------------------------------------------------------+
| [設定]                                                          |
|-----------------------------------------------------------------|
| ▲                                                               |
| | **あなた:** 在宅勤務の交通費精算について教えて               |
| |                                                               |
| | **アシスタント:** |
| | 在宅勤務の際の交通費は、業務に必要な場合に限り...             |
| | **出典:** - 経費精算規定_ver3.pdf                             |
| |                                                               |
| ▼                                                               |
|-----------------------------------------------------------------|
| > [ここに質問を入力してください]                         [送信] |
+-----------------------------------------------------------------+
```

**Q&A処理中:**

```text
+-----------------------------------------------------------------+
| ローカルナレッジアシスタント v0.1                                |
+-----------------------------------------------------------------+
| [設定]                                                          |
|-----------------------------------------------------------------|
| ▲                                                               |
| | **あなた:** 在宅勤務の交通費精算について教えて               |
| |                                                               |
| | **アシスタント:** (回答生成中...)                            |
| |                                                               |
| ▼                                                               |
|-----------------------------------------------------------------|
| > [（入力不可）]                                   [キャンセル] |
+-----------------------------------------------------------------+
```

##### 3.2.2. コンポーネント仕様

| No | コンポーネントID | コンポーネント名 | UIライブラリ部品 (Streamlit) | 表示内容 / ラベル | アクション / 動作仕様 |
| :- | :--- | :--- | :--- | :--- | :--- |
| 1 | **SCR01-H01** | **ヘッダータイトル** | `st.header` | `ローカルナレッジアシスタント v0.1` | 静的表示。アプリケーションの名称とバージョンを示す。 |
| 2 | **SCR01-B01** | **設定ボタン** | `st.button` | `設定` | クリックすると、設定画面 (SCR-02) を表示する。 |
| 3 | **SCR01-A01** | **チャット履歴エリア** | `st.container` | ユーザーとアシスタントの対話履歴。 | ・`st.session_state['chat_history']` で対話履歴を保持し、再描画時に表示。  ・履歴がエリアの高さを超える場合は、縦スクロールバーを表示。  ・最新のメッセージが最下部に表示されるように自動スクロールする。 |
| 4 | **SCR01-M01** | **ユーザーメッセージ** | `st.markdown` | `**あなた:**`    `(ユーザーが入力した質問テキスト)` | チャット履歴エリア内に表示される。 |
| 5 | **SCR01-M02** | **アシスタントメッセージ** | `st.markdown` | `**アシスタント:**`    `(LLMが生成した回答テキスト)` | チャット履歴エリア内に表示される。 |
| 6 | **SCR01-M03** | **出典表示** | `st.markdown` | `**出典:**`    `- (ファイル名1)` | アシスタントメッセージの下に表示される。回答の根拠となった文書のファイル名をリスト形式で表示する。 |
| 7 | **SCR01-I01** | **質問入力ボックス** | `st.text_input` | プレースホルダー: `ここに質問を入力してください` | ・ユーザーからのテキスト入力を受け付ける。  ・Enterキー押下で、送信ボタン (SCR01-B02) のクリックと同じアクションを実行する。  ・`st.session_state['app_state']` が `'processing_qa'` の間は無効化（入力不可）される。 |
| 8 | **SCR01-B02** | **送信ボタン** | `st.button` | `送信` | ・`st.session_state['app_state']` が `'idle'` の場合に表示。  ・クリックすると、バックエンド処理を開始し、`st.session_state['app_state']` を `'processing_qa'` に変更する。  ・質問受信時にタイムスタンプを記録する。 |
| 9 | **SCR01-B03** | **キャンセルボタン (Q&A)** | `st.button` | `キャンセル` | ・`st.session_state['app_state']` が `'processing_qa'` の場合に表示。  ・クリックすると、`st.session_state['cancel_requested']` を `True` に設定する。  ・バックエンド処理は、このフラグを定期的に確認し、`True` の場合は処理を中断する。 |

---

#### 3.3. 設定画面 (SCR-02) 詳細

##### 3.3.1. ワイヤーフレーム

**通常時:**

```text
+------------------------------------------------------+
| 設定                                         [×]    |
+------------------------------------------------------+
| **ナレッジフォルダ設定** |
| C:\Users\YourName\Documents\社内規定         [変更]  |
|------------------------------------------------------|
| **インデックス** |
| 最終更新: 2025/08/30 10:00                          |
|                                        [今すぐ更新]  |
|------------------------------------------------------|
|                                              [閉じる]|
+------------------------------------------------------+
```

**インデックス作成処理中:**

```text
+------------------------------------------------------+
| 設定                                         [×]    |
+------------------------------------------------------+
| **ナレッジフォルダ設定** |

| C:\Users\YourName\Documents\社内規定         [変更]  |
|------------------------------------------------------|
| **インデックス** |
| 処理中... (5/50 ファイル完了)                        |
| [■■■■■□□□□□□□□□□□□□□□] [キャンセル]             |
|------------------------------------------------------|
|                                              [閉じる]|
+------------------------------------------------------+
```

##### 3.3.2. コンポーネント仕様

| No | コンポーネントID | コンポーネント名 | UIライブラリ部品 (Streamlit) | 表示内容 / ラベル | アクション / 動作仕様 |
| :- | :--- | :--- | :--- | :--- | :--- |
| 1 | **SCR02-H01** | **ヘッダータイトル** | `st.header` | `設定` | 静的表示。画面の目的を示す。 |
| 2 | **SCR02-B01** | **画面を閉じるボタン** | `st.button` | `×` | クリックすると、設定画面を非表示にし、メイン画面に戻る。 |
| 3 | **SCR02-S01** | **ナレッジフォルダ設定セクション** | `st.subheader` | `ナレッジフォルダ設定` | 静的表示。セクションタイトル。 |
| 4 | **SCR02-D01** | **現在のフォルダパス表示** | `st.text_input` (disabled) | 現在設定されているフォルダの絶対パス | ・読み取り専用で現在の設定値を表示する。  ・設定値は `st.session_state['config']` から読み込む。 |
| 5 | **SCR02-B02** | **フォルダ変更ボタン** | `st.button` | `変更` | ・クリックすると、OSのフォルダ選択ダイアログを開く。  ・新しいフォルダを選択後、`st.session_state['config']` を更新し、`config.json` ファイルに保存する。  ・フォルダ変更後、「インデックスの再構築が必要です」というメッセージ (`st.info`) を表示する。 |
| 6 | **SCR02-S02** | **インデックスセクション** | `st.subheader` | `インデックス` | 静的表示。セクションタイトル。 |
| 7 | **SCR02-D02** | **最終更新日時表示** | `st.markdown` | `最終更新: YYYY/MM/DD HH:mm` | `st.session_state['config']` に保存された最終更新日時を表示する。 |
| 8 | **SCR02-B03** | **インデックス更新ボタン** | `st.button` | `今すぐ更新` | ・`st.session_state['app_state']` が `'idle'` の場合に表示。  ・クリックすると、バックエンド処理を開始し、`st.session_state['app_state']` を `'processing_indexing'` に変更する。 |
| 9 | **SCR02-P01** | **進捗表示エリア** | `st.container` | `処理中... (X/Y ファイル完了)`  `st.progress(value)` | ・`st.session_state['app_state']` が `'processing_indexing'` の場合に表示。  ・インデックス作成処理のループ内で、ファイル処理ごとにUIを更新し、進捗状況をリアルタイムに表示する。 |
| 10 | **SCR02-B04** | **キャンセルボタン (インデックス)** | `st.button` | `キャンセル` | ・`st.session_state['app_state']` が `'processing_indexing'` の場合に表示。  ・クリックすると、`st.session_state['cancel_requested']` を `True` に設定する。  ・バックエンド処理は、このフラグを定期的に確認し、`True` の場合は処理を中断する。 |
| 11 | **SCR02-B05** | **閉じるボタン (フッター)** | `st.button` | `閉じる` | クリックすると、設定画面を非表示にし、メイン画面に戻る (SCR02-B01 と同じ機能)。 |

---

### 4. 共通仕様

| 項目 | 仕様 |
| :--- | :--- |
| **状態管理** | アプリケーションの状態は `st.session_state` で一元管理する。  ・`st.session_state['app_state']`: アプリケーションの主要な状態 (`'idle'`, `'processing_qa'`, `'processing_indexing'`)  ・`st.session_state['cancel_requested']`: 中断要求の有無 (`True` / `False`)  ・`st.session_state['chat_history']`: 対話履歴のリスト  ・`st.session_state['config']`: ナレッジフォルダパスや最終更新日時などの設定情報 |
| **処理の中断メカニズム** | ・長時間処理（Q&A、インデックス作成）のループ内部で、定期的に `st.session_state['cancel_requested']` をチェックする。  ・フラグが `True` の場合、ループを `break` し、処理を安全に終了する。  ・中断後、チャット履歴や設定画面に「処理が中断されました」というメッセージを表示し、`app_state` を `'idle'` に、`cancel_requested` を `False` に戻す。 |
| **パフォーマンス目標** | ・**目標値:** ユーザーが質問を送信してから、回答が画面に表示されるまでの時間は**30秒以内**を目標とする（ベストエフォート）。  ・**測定方法:** 質問送信時と回答表示完了時にタイムスタンプ (`datetime.now()`) を取得し、その差分をコンソールログに出力する機能を実装する。「`[PERF] Response time: X.XX seconds`」の形式で出力すること。 |
| **永続化** | ・ナレッジフォルダのパス、インデックスの最終更新日時などの設定情報は、`st.session_state['config']` の内容と同期させ、変更があるたびにローカルの `config.json` ファイルに保存する。  ・チャット履歴は、アプリケーション実行中のセッション内 (`st.session_state['chat_history']`) でのみ保持する。 |
| **UIフィードバック** | ・**ロード中:** 時間のかかる処理の実行中は、ユーザーに処理中であることが分かるようにインジケータ（プログレスバーやスピナー）を表示する (`st.spinner`, `st.progress`)。  ・**エラー:** ファイル読み込み失敗、LLM応答エラー等の場合は、その内容をユーザーに分かりやすく通知する (`st.error`)。  ・**情報:** 処理に関する注意喚起や補足情報（例: フォルダ変更後のインデックス更新推奨）を表示する (`st.warning`, `st.info`)。 |

---

### 5. 実装詳細

#### 5.1. ファイル・ディレクトリ構造

本アプリケーションの実装は、以下のファイルおよびディレクトリ構造に従うこと。これにより、責務の分離とコードの可読性を確保する。

```text
local-knowledge-agent/
│
├── .streamlit/
│   └── config.toml           # Streamlitのテーマや設定（オプション）
│
├── data/
│   ├── chroma_db/            # ChromaDBの永続化データが保存されるディレクトリ
│   └── config.json           # ナレッジフォルダパス等の設定を保存するファイル
│
├── src/
│   ├── __init__.py
│   ├── logic/
│   │   ├── __init__.py
│   │   ├── indexing.py       # ドキュメントの読み込み、分割、インデックス作成ロジック
│   │   └── qa.py             # Q&Aパイプラインの構築と実行ロジック
│   │
│   └── ui/
│       ├── __init__.py
│       ├── main_view.py      # メイン画面(SCR-01)のUIコンポーネントとロジック
│       └── settings_view.py  # 設定画面(SCR-02)のUIコンポーネントとロジック
│
├── app.py                    # Streamlitアプリケーションのエントリーポイント
├── requirements.txt          # 依存ライブラリ一覧
└── README.md                 # プロジェクトの説明書
```

**各ファイル/ディレクトリの責務:**

* `app.py`: アプリケーションの起動、`st.session_state` の初期化、UIモジュール（`main_view`, `settings_view`）の呼び出しなど、全体的な制御を行う。
* `src/logic/indexing.py`: ファイルの読み込み、チャンクへの分割、ベクトル化、ChromaDBへの保存といった、インデックス作成に関連する全てのバックエンド処理をカプセル化する。
* `src/logic/qa.py`: ベクトルDBからの文書検索、プロンプトの構築、Ollamaへの問い合わせといった、Q&A応答生成に関連する全てのバックエンド処理をカプセル化する。
* `src/ui/main_view.py`: メイン画面のUIレイアウトと、ユーザー操作に応じたバックエンドロジック（`qa.py`）の呼び出しを担当する。
* `src/ui/settings_view.py`: 設定画面のUIレイアウトと、ユーザー操作に応じたバックエンドロジック（`indexing.py`）の呼び出しを担当する。
* `data/`: ユーザーデータや設定など、アプリケーションが実行中に生成・利用する全ての永続化データを格納する。このディレクトリはGitの管理対象外（`.gitignore`に記載）とすることが望ましい。

#### 5.2. 日本語回答制御機能

**概要:** 全ての質問に対して日本語で回答を生成するようLLMを制御する機能。

**実装仕様:**

* **プロンプト制御:** RAGパイプラインで生成するプロンプトの先頭に「日本語で回答してください。」という指示を含める。
* **データモデル拡張:** QAResultクラスに`response_language: str = "ja"`フィールドを追加し、常に日本語固定とする。
* **一貫性保証:** 通常のRAGモードと直接QAモード（文書なし）の両方で日本語指示を適用する。

**技術実装:**

```python
# プロンプトテンプレート例
qa_prompt_template = """日本語で回答してください。

以下のコンテキスト情報を参考にして、ユーザーの質問に正確で有用な回答を提供してください。

【コンテキスト情報】
{context}

【質問】
{query}

【回答】"""

# QAResultモデル
@dataclass
class QAResult:
    query: str
    answer: str
    sources: List[Dict[str, Any]]
    context: str
    response_language: str = "ja"  # 日本語固定
    ...
```

**検証方法:**

* 英語、日本語、その他言語での質問に対して全て日本語回答を生成することを自動テストで確認
* ドキュメントが存在しない場合でも日本語回答制御が機能することを確認
